generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  MASTER
  SLAVE
  SELLER
}

enum TableType {
  POOL
  BAR
}

enum TicketKind {
  RENTAL
  BAR
}

enum TicketStatus {
  OPEN
  CHECKOUT
  PAID
  CANCELED
}

enum PaymentMethod {
  CASH
  DEBIT
}

enum StockMoveType {
  IN
  OUT
  ADJUST
}

model User {
  id           String   @id @default(uuid())
  username     String   @unique
  name         String
  passwordHash String
  role         Role
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())

  openedTickets Ticket[]  @relation("OpenedBy")
  paidPayments  Payment[] @relation("PaidBy")
}

model Table {
  id      Int       @id
  name    String
  type    TableType
  tickets Ticket[]
}

model Ticket {
  id            String       @id @default(uuid())
  tableId       Int
  table         Table        @relation(fields: [tableId], references: [id])
  kind          TicketKind
  status        TicketStatus @default(OPEN)

  openedById    String
  openedBy      User         @relation("OpenedBy", fields: [openedById], references: [id])

  startedAt     DateTime?
  endedAt       DateTime?
  minutesPlayed Int?
  rentalAmount  Int?

  items         TicketItem[]
  payment       Payment?

  createdAt     DateTime     @default(now())
}

model Product {
  id            String   @id @default(uuid())
  name          String   @unique
  category      String
  price         Int
  stock         Int      @default(0)
  stockCritical Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  items         TicketItem[]
  stockMoves    StockMovement[]
}

model TicketItem {
  id        String  @id @default(uuid())
  ticketId  String
  ticket    Ticket  @relation(fields: [ticketId], references: [id])

  productId String
  product   Product @relation(fields: [productId], references: [id])

  qty       Int
  unitPrice Int
  lineTotal Int
}

model Payment {
  id            String        @id @default(uuid())
  ticketId      String        @unique
  ticket        Ticket        @relation(fields: [ticketId], references: [id])

  method        PaymentMethod
  totalAmount   Int
  receiptNumber Int           @default(autoincrement())

  paidById      String
  paidBy        User          @relation("PaidBy", fields: [paidById], references: [id])

  paidAt        DateTime      @default(now())
}

model StockMovement {
  id          String        @id @default(uuid())
  productId   String
  product     Product       @relation(fields: [productId], references: [id])

  type        StockMoveType
  qty         Int
  reason      String
  createdById String
  createdAt   DateTime      @default(now())
}
